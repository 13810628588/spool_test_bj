<!DOCTYPE html>
<html>

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="The Matrix Components Framework">
        <meta name="author" content="LY">
        <title>中国平安</title>
        <link rel="shortcut icon" href="assets/self-owned/ico/favicon.png">
        <link rel="stylesheet" type="text/css" href="assets/reference/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="assets/reference/flat-ui/css/flat-ui.css">
        <link rel="stylesheet" type="text/css" href="assets/reference/font-awesome/css/font-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="assets/self-owned/css/matrix.css">
        <link rel="stylesheet" type="text/css" href="assets/reference/bootstrap-fileinput/css/fileinput.min.css" media="all">


    </head>

    <body>
        <!-- <div class="flat-matrix" style="margin-top:-58px;"> -->

        <div class="flat-matrix" style="background-image: url(assets/self-owned/img/jianzheng2.jpg);background-repeat: no-repeat;background-size:100% 100%;margin-top:-58px;">
            <div class="app-container">
                <div class="row content-container">
                    <!-- 应用左侧NAV导航，可以应用与assist，帮助，过滤等辅助组件，默认自动收缩扩展，支持悬停（点击右上角按钮切换）-->
                    <div class="container">
                        <div>

                            <div class="row">

                                <!-- logo of the pingan -->
                                <div style="margin-top:58px;">&nbsp;</div>
                                <div>
                                    <img id="pinganlogo" class="img-responsive" src="assets/self-owned/img/pingan1.jpg" alt="" style="width:30%;display: block;position: relative;margin: auto;">
                                </div>
                                <!-- title: such lik kaimenhong -->

                                <div id="matrix_upload_div" style="margin:0px 20px">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div>
                                                <div class="alert fresh-color " data-bind="css:alerts.styleClass,visible:alerts.resultVisible">
                                                    <button type="button" class="close" data-bind="click:alerts.resultVisible(false)" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                    <strong>
                                                        <span data-bind="text:alerts.resultTitle"></span>
                                                    </strong>
                                                    <span data-bind="text:alerts.resultSubTitle"></span>
                                                    <div data-bind="text:alerts.resultContent"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div data-bind="foreach:uploadedFileUrls">
                                            <div class="col-xs-6 text-center" style="margin-bottom:10px">
                                                <img data-bind="attr:{src:$data}" class="img-thumbnail" style="width:180px;height:180px">
                                            </div>
                                        </div>

                                    </div>
                                    <br>

                                    <div class="row">
                                        <div class="col-xs-12">
                                            <form class="form-horizontal">
                                                <div class="form-group">
                                                    <div class="col-xs-12" >
                                                        <input id="input-id" type="file" name="file" >
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                </div>

                                <div id="validation_div" style="margin:0px 18px">
                                    <!--Validation DIV BEGIN-->
                                    <div data-bind="visible: hasError" class="alert alert-warning alert-dismissible fresh-color" role="alert">
                                        <button type="button" data-bind="click:function(){hasError(!hasError)}" class="close" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                        <strong>友情提示:</strong>
                                        <div id="errorMessagesDIV" data-bind="foreach:errorMessage">
                                            <div data-bind="text:$data"></div>
                                        </div>
                                    </div>
                                    <!--Validation DIV END-->
                                </div>

                                <div id="business_content_div">

                                    <!-- form div -->
                                    <div class="col-xs-12 text-center">

                                        <form class="form-horizontal">
                                            <div class="form-group">
                                                <label class="col-xs-12 ">
                                                    <span style="font-weight: bold;font-size: 18px;color:#e74c3c">请选择见证卡类型</span>
                                                </label>
                                            </div>
                                            <div class="form-group">
                                                <div class="col-xs-6 col-xs-offset-3 text-center">
                                                    <select class="form-control" style="width:100%" data-bind="options:items,value:chosenItem,optionsCaption: '请选择...'"></select>
                                                </div>
                                            </div>
                                            <br>
                                            <div class="form-group">
                                                <label class="col-xs-12 ">
                                                    <span style="font-weight: bold;font-size: 18px;color:#e74c3c">2016年我想要......</span>
                                                </label>
                                            </div>
                                            <div class="form-group text-center">
                                                <div class="col-xs-12 text-center" style="overflow: auto">
                                                    <textarea data-bind="value:description,valueUpdate:'input'" rows="3" cols="28" placeholder="请在此许下您的心愿"></textarea>
                                                </div>
                                            </div>
                                        </form>
                                        <div class="col-xs-12 text-center">
                                            <a class="btn btn-danger  btn-wide text-center" style="width:260px; color:white" onclick="persist()">请您的亲人朋友共同见证吧</a>
                                        </div>
                                        <br><br><br>


                                        <div class="" style="color:white;font-size:11px">
                                            <p><strong>本活动最终解释权归中国平安所有</strong> </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>


        <script src="assets/reference/jquery/jquery-1.11.1.min.js"></script>
        <script src="assets/reference/jquery/jquery.json.js"></script>
        <script src="assets/reference/knockout.js/knockout-3.3.0.js"></script>
        <script src="assets/reference/jquery-tiny-pubsub/tiny-pubsub.js"></script>
        <script src="assets/reference/flat-ui/js/vendor/video.js"></script>
        <script src="assets/reference/flat-ui/js/flat-ui.min.js"></script>
        <script src="assets/reference/flat-ui/docs/assets/js/prettify.js"></script>
        <script src="assets/reference/flat-ui/docs/assets/js/application.js"></script>
        <script src="assets/reference/bootstrap-fileinput/js/fileinput.js"></script>
        <script src="assets/reference/bootstrap-fileinput/js/locales/zh.js"></script>
        <!-- Javascript for Matrix Self Owned -->
        <script src="assets/self-owned/js/generic/generic_algorithm.js"></script>
        <script src="assets/self-owned/js/generic/generic_cache.js"></script>
        <script src="assets/self-owned/js/generic/generic_charting.js"></script>
        <script src="assets/self-owned/js/generic/generic_csv.js"></script>
        <script src="assets/self-owned/js/generic/generic_cud.js"></script>
        <script src="assets/self-owned/js/generic/generic_modal.js"></script>
        <script src="assets/self-owned/js/generic/generic_prototype.js"></script>
        <script src="assets/self-owned/js/generic/generic_query.js"></script>
        <script src="assets/self-owned/js/generic/generic_table.js"></script>
        <script src="assets/self-owned/js/generic/generic_util.js"></script>
        <script src="assets/self-owned/js/generic/generic_validation.js"></script>
        <script src="assets/self-owned/js/generic/generic_upload.js"></script>

        
        <script>
            function getUserInfo() {
                var query = {"param1": "YINGXIAO_OR_QUTUO"};
                var url = $.getRootPath() + "/api/account/getUserInfo";
                var data = {
                    'queryJson': JSON.stringify(query)
                }


                $.serverRequest(url, data, "JIANZHENG_GET_USER_INFO_SUCCESS", "JIANZHENG_GET_USER_INFO_RESPONSE_ERROR", "JIANZHENG_GET_USER_INFO_SERVER_ERROR", "POST");

                $.subscribe("JIANZHENG_GET_USER_INFO_SUCCESS", jianzhengGetUserInfoSuccessListener);
                $.subscribe("JIANZHENG_GET_USER_INFO_RESPONSE_ERROR", jianzhengGetUserInfoFailedListener);
                $.subscribe("JIANZHENG_GET_USER_INFO_SERVER_ERROR", jianzhengGetUserInfoFailedListener);

            }

            function jianzhengGetUserInfoSuccessListener() {

                if (arguments && arguments[1]) {
                    var resp = arguments[1];
                    var userInfo = eval("(" + resp.result[0] + ")");
                    business_vm.userInfo(userInfo);
                }
            }

            function jianzhengGetUserInfoFailedListener() {
                console.log("get user failed")
                location.href = $.getRootPath() + '/pingan_jianzhengka_1.html';
            }


        </script>
        <script>
                                                function BusinessViewModel() {
                                                    var self = this;
                                                    self.items = ko.observableArray(['感恩型', '荣誉型', '分享型']);
                                                    self.chosenItem = ko.observable();
                                                    self.description = ko.observable();
                                                    self.userInfo = ko.observable();
                                                }
                                                var business_vm = new BusinessViewModel();
                                                ko.applyBindings(business_vm, document.getElementById('business_content_div'));

                                                var vm = new GenericUploadPageViewModel();
                                                ko.applyBindings(vm, document.getElementById('matrix_upload_div'));
                                                $.subscribe("SUCCESS_LISTENER", successListener);
                                                $.subscribe("FAILED_LISTENER", failedListener);
                                                initialize_pic_upload_environment('input-id', vm);
                                                getUserInfo();

                                                function failedListener() {
                                                    if (arguments && arguments[1]) {
                                                        var errorMessage = arguments[1].errorMessage;
                                                        vm.alerts.errorResponse(errorMessage, "Server Service Error!", "Please read the message below:");
                                                    }
                                                }

                                                function successListener() {
                                                    if (arguments && arguments[1]) {

                                                        var img_url_path = $.getServerRoot() + "/service_generic_query" + arguments[1].result[0].stringkappa;
                                                        debugger;
                                                        if (vm) {
                                                            vm.uploadedFileUrls.push(img_url_path);

                                                            setTimeout(function () {
                                                                $('#input-id').fileinput('refresh');
                                                            }, 200);
                                                        }
                                                    }
                                                }

                                                // *******YOUR SHOULD CODING IN HERE:*******
                                                var businessValidation = function () {
                                                    var errorMessages = [];
                                                    //validate logic...

                                                    //validate
                                                    ValidationPOJO.validate("见证卡类型", business_vm.chosenItem(), errorMessages, ['KEY_NOT_NULL']);
                                                    ValidationPOJO.validate("您的心愿", business_vm.description(), errorMessages, ['KEY_NOT_NULL', 'KEY_NOT_MAX']);

                                                    if (vm.uploadedFileUrls().length < 1) {
                                                        errorMessages.push("您还没有上传图片");
                                                    }
                                                    return errorMessages;
                                                }

                                                var genericModalViewModel = new GenericModalViewModel();
                                                ko.applyBindings(genericModalViewModel, document.getElementById('validation_div'));

                                                function persist() {
                                                    if (!genericModalViewModel.validation(businessValidation)) {
                                                        return;
                                                    } else {
                                                        // validation correct
                                                        // do your business...
                                                        var json = {
                                                            file_url_list: vm.uploadedFileUrls(),
                                                            business_info: {
                                                                info_1: business_vm.chosenItem(),
                                                                info_2: business_vm.description()
                                                            }
                                                        }

                                                        var param = JSON.stringify(json);

                                                        param = UtilPOJO.encode(param);
                                                        var shareJson = {
                                                            'type': 'JianZhengKa',
                                                            'json': param,
                                                            'username': business_vm.userInfo().staff_name,
                                                            'stringalpha': business_vm.userInfo().personal_code
                                                        }
                                                        var data = {
                                                            'shareJson': $.toJSON(shareJson)
                                                        };

                                                        $.serverRequest($.getServerRoot() + '/service_generic_query/api/share/generate/9999', data, "TOKEN_SUCCESS", "TOKEN_FAILED", "TOKEN_SERVICE_FAILED");

                                                    }

                                                }
                                                $.subscribe("TOKEN_SUCCESS", tokenSuccessListener);
                                                $.subscribe("TOKEN_FAILED", tokenFailedListener);
                                                $.subscribe("TOKEN_SERVICE_FAILED", tokenServiceListener);

                                                function tokenSuccessListener() {
                                                    if (arguments && arguments[1]) {
                                                        window.location.replace($.getRootPath() + '/pingan_jianzhengka_3.html?token=' + arguments[1].result[0]);
                                                    }
                                                }

                                                function tokenFailedListener() {
                                                    if (arguments && arguments[1]) {
                                                        var errorMessage = arguments[1].errorMessage;
                                                        console.log(errorMessage);
                                                    }
                                                }

                                                function tokenServiceListener() {
                                                }
        </script>
        
    </body>

</html>
